<html>
	<head>
		<title>Track a Workout</title>
		<link rel="stylesheet" href="css/workoutStyle.css" />
		<link rel="stylesheet" href="css/sharedStyle.css" />
		<link rel="stylesheet" href="./css/sharedStyle.css" />
		<!-- <link rel="stylesheet" href="css/dashboardStyle.css"> -->
	</head>
	<body>
		<!-- topBar -->
		<header class="topBar">
			<div>
				<img src="images/activ8logo.png" />
				<h1 class="appName">Activ8</h1>
			</div>
			<div class="rightButts">
				<img src="./images/settings.png" alt="" class="settings-icon" />
				<!-- <a href="login.html" class="logoutButt">Logout</a> -->
				<button class="logoutButt" onclick="window.location.href='index.html'">Logout</button>
			</div>
		</header>

		<!-- navBar -->
		<div class="navBar">
			<a href="./dashboard.html" class="navbar-link">Dashboard</a>
			<a href="./mealTracking.html" class="navbar-link">Track a Meal</a>
			<a href="./workout.html" class="navbar-link selected">Track a Workout</a>
			<a href="./community.html" class="navbar-link">Community Page</a>
			<a href="./community.html" class="navbar-link" id="createAPostBtn">Create a Post</a>
		</div>

		<!-- popup window for settings -->
		<div class="setting-pop-up">
			<div class="setting-pop-up-header">
				<img src="./images/close-btn.png" alt="" class="setting-close-btn" />
			</div>
			<div class="setting-pop-up-content">
				<div class="setting-pop-up-change-username">
					<span>Change username: </span>
					<div>
						<input type="text" class="setting-change-username-input" />
						<button class="setting-change-username-confirm-btn">confirm</button>
					</div>
				</div>
				<div class="setting-pop-up-change-fontsize">
					<span>Change font size:</span>
					<div class="setting-font-size-container">
						<img src="./images/letter-a-2.png" alt="" class="font-size-letter font-size-letter-1" />
						<img src="./images/letter-a-2.png" alt="" class="font-size-letter font-size-letter-2 selected" />
						<img src="./images/letter-a-2.png" alt="" class="font-size-letter font-size-letter-3" />
					</div>
				</div>
				<div class="setting-pop-up-change-color">
					<span>Change color scheme:</span>
					<div class="setting-color-big-container">
						<div class="setting-color-container">
							<div class="color-palette-option color-palette-option-default selected" data-color-option="default">
								<img src="./images/color-palette/default.png" alt="" class="color-palette color-palette-default" />
								<span class="color-palette-text">Default</span>
							</div>
							<div class="color-palette-option color-palette-option-rgblind" data-color-option="rg-blind">
								<img src="./images/color-palette/rg-blind.png" alt="" class="color-palette color-palette-rgblind" />
								<span class="color-palette-text">color blind friendly</span>
							</div>
							<div class="color-palette-option color-palette-option-dark" data-color-option="dark">
								<img src="./images/color-palette/dark.png" alt="" class="color-palette color-palette-dark" />
								<span class="color-palette-text">Dark theme</span>
							</div>
						</div>
						<div class="info-icon-color-explanation-container">
							<img src="./images/info.png" alt="" class="info-icon-color-explanation" />
						</div>
					</div>
				</div>
			</div>
			<div class="setting-pop-up-overlay"></div>
			<div class="setting-pop-up-top-level-message">
				<div class="setting-pop-up-header">
					<img src="./images/close-btn.png" alt="" class="setting-close-btn setting-second-message-close-btn" />
				</div>
				<div class="setting-pop-up-content">
					* color-blind means "red/green color-blind" here<br /><br />
					* Color selection for "color-blind friendly" option is from this website:
					<a
						href="https://www.nceas.ucsb.edu/sites/default/files/2022-06/Colorblind%20Safe%20Color%20Schemes.pdf"
						target="_blank">
						Colorblind Safe Color Schemes
					</a>
				</div>
			</div>
		</div>

		<div class="overlay" id="overlay"></div>

		<div class="workoutHeading">
			<a href="dashboard.html" class="returnLink">Dashboard</a> >
			<span> Track a Workout </span>
			<!-- </h2>   FIXME: why is there a h2 label ??-->
		</div>
		<label class="dateLabel"> </label>
		<div class="searchContainer">
			<!-- <label class="dateLabel"> </label> -->
			<div class="searchBar">
				<img src="images/magnifyingGlass.png" />
				<input type="text" id="searchInput" placeholder="Search an exercise to add to workout" />
				<div id="exerciseSearch" class="exerciseSearch"></div>
			</div>
		</div>

		<div class="outerFieldsContainer">
			<div class="fieldsContainer">
				<div class="leftFields"></div>
				<div class="rightFields">
					<div class="rightExerciseContainer"></div>
					<div class="commentContainer">
						<label class="commentLabel">Personal Comment:</label>
						<textarea
							type="text"
							class="commentBox"
							placeholder="Write your personal comment about today's workout"></textarea>
					</div>
				</div>
			</div>
		</div>
		<button class="submitBtn" type="button">submit</button>
		<script id="exerciseData" type="application/json">
			{
				"exercises": [
					{"id": 1, "name": "squat", "type": "resistance training"},
					{"id": 2, "name": "dumbell squat", "type": "resistance training"},
					{"id": 3, "name": "pull-up", "type": "resistance training"},
					{"id": 4, "name": "pushup", "type": "resistance training"},
					{"id": 5, "name": "run", "type": "cardiovsascular training"},
					{"id": 5, "name": "walk", "type": "cardiovsascular training"},
					{"id": 6, "name": "bike", "type": "cardiovsascular training"},
					{"id": 7, "name": "bench press", "type": "resistance training"},
					{"id": 8, "name": "seated shoulder press", "type": "resistance training"},
					{"id": 9, "name": "swim", "type": "cardiovsascular training"},
					{"id": 10, "name": "bicep curl", "type": "resistance training"},
					{"id": 11, "name": "tricep extension", "type": "resistance training"},
					{"id": 12, "name": "seated row", "type": "resistance training"},
					{"id": 13, "name": "walking lunges", "type": "resistance training"}
				]
			}
		</script>
		<script>
			// Parse JSON embedded in the HTML
			const exerciseJSON = document.getElementById('exerciseData').textContent;
			const exercises = JSON.parse(exerciseJSON).exercises;

			const exerciseInput = document.getElementById('searchInput');
			const exerciseSearch = document.getElementById('exerciseSearch');
			const leftFields = document.querySelector('.leftFields');
			const rightExerciseContainer = document.querySelector('.rightExerciseContainer');
			const WORKOUT_STORAGE_KEY = 'workouts';

			// Display today's date
			const dateLabel = document.querySelector('.dateLabel');
			const today = new Date();
			const formattedDate = today.toLocaleDateString('en-US', {
				year: 'numeric',
				month: 'long',
				day: 'numeric',
			});

			// do date conversition here (to ISO format: YYYY-MM-DD)
			// so dashborad can directly get data from storage
			const isoDate = today.toISOString().split('T')[0];
			dateLabel.textContent = `Today's workout: ${formattedDate}`;
			function saveWorkoutSession(workout) {
				let existing = [];
				try {
					existing = JSON.parse(sessionStorage.getItem(WORKOUT_STORAGE_KEY)) || [];
				} catch (error) {
					console.warn('Unable to parse existing workouts, resetting list.', error);
				}
				existing.push(workout);
				sessionStorage.setItem(WORKOUT_STORAGE_KEY, JSON.stringify(existing));
			}

			// Search bar behavior
			exerciseInput.addEventListener('focus', () => {
				exerciseInput.placeholder = '';
				if (exerciseInput.value.trim() !== '' && exerciseSearch.innerHTML.trim() !== '') {
					exerciseSearch.style.display = 'block';
				}
			});

			exerciseInput.addEventListener('blur', () => {
				if (exerciseInput.value === '') {
					exerciseInput.placeholder = 'Search an exercise to add to workout';
				}
			});

			exerciseInput.addEventListener('input', () => {
				const query = exerciseInput.value.toLowerCase().trim();
				if (!query) {
					exerciseSearch.style.display = 'none';
					exerciseSearch.innerHTML = '';
					return;
				}
				const filtered = exercises.filter((ex) => ex.name.toLowerCase().includes(query));
				displayResults(filtered);
			});

			function displayResults(results) {
				exerciseSearch.innerHTML = '';
				if (results.length === 0) {
					exerciseSearch.innerHTML = '<p class="noResults">No exercise matches your search</p>';
				} else {
					results.forEach((ex) => {
						const div = document.createElement('div');
						div.classList.add('exerciseResult');
						div.textContent = `${ex.name} (${ex.type})`;
						div.addEventListener('click', () => {
							addExerciseBox(ex.name, ex.type);
							exerciseInput.value = '';
							exerciseSearch.innerHTML = '';
							exerciseSearch.style.display = 'none';
							exerciseInput.placeholder = 'Search an exercise to add to workout';
						});
						exerciseSearch.appendChild(div);
					});
				}
				exerciseSearch.style.display = 'block';
			}

			document.addEventListener('click', (event) => {
				const isClickInside = exerciseInput.contains(event.target) || exerciseSearch.contains(event.target);
				if (!isClickInside) exerciseSearch.style.display = 'none';
			});

			// Add exercises
			let firstExerciseType = null;

			function addExerciseBox(exerciseName, exerciseType) {
				const wrapper = document.createElement('div');
				wrapper.classList.add('exerciseWrapper');

				const box = document.createElement('div');
				const exerciseTitle = document.createElement('div');
				const x = document.createElement('div');

				exerciseTitle.classList.add('exerciseTitle');
				exerciseTitle.textContent = exerciseName;
				box.appendChild(exerciseTitle);
				box.classList.add('exerciseBox');

				x.classList.add('removeExercise');
				x.textContent = 'X';
				box.appendChild(x);

				x.addEventListener('click', () => wrapper.remove());

				const labelsContainer = document.createElement('div');
				labelsContainer.classList.add('labelsContainer');

				const typeLower = exerciseType.toLowerCase();
				let targetColumn;

				if (!firstExerciseType) {
					firstExerciseType = typeLower;
					targetColumn = leftFields;
				} else {
					targetColumn = typeLower === firstExerciseType ? leftFields : rightExerciseContainer;
				}

				if (typeLower.includes('resistance')) {
					const setsContainer = document.createElement('div');
					setsContainer.classList.add('setsContainer');
					labelsContainer.appendChild(setsContainer);

					for (let i = 1; i <= 3; i++) addSetToContainer(setsContainer, i);

					const setControls = document.createElement('div');
					setControls.classList.add('setControls');

					const addSet = document.createElement('div');
					addSet.classList.add('setButton');
					addSet.textContent = '+';

					const removeSet = document.createElement('div');
					removeSet.classList.add('setButton');
					removeSet.textContent = 'âˆ’';

					const setLabel = document.createElement('label');
					setLabel.classList.add('setControlLabel');
					setLabel.textContent = 'sets';

					setControls.append(addSet, removeSet, setLabel);
					labelsContainer.appendChild(setControls);

					addSet.addEventListener('click', () => {
						const count = setsContainer.querySelectorAll('.setRow').length;
						addSetToContainer(setsContainer, count + 1);
					});
					removeSet.addEventListener('click', () => {
						const setRows = setsContainer.querySelectorAll('.setRow');
						if (setRows.length > 1) setRows[setRows.length - 1].remove();
					});
				} else if (typeLower.includes('cardio')) {
					const labels = ['Distance (km)', 'Time (min)', 'Avg Speed (min/km)'];
					labels.forEach((text) => {
						const wrapperDiv = document.createElement('div');
						wrapperDiv.classList.add('dataWrapper');

						const label = document.createElement('label');
						label.classList.add('cardioLabel');
						label.textContent = text;

						const input = document.createElement('input');
						input.type = 'text';
						input.placeholder = 'enter value';
						input.classList.add('cardioInput');

						wrapperDiv.append(label, input);
						labelsContainer.appendChild(wrapperDiv);
					});
				}

				wrapper.append(box, labelsContainer);
				targetColumn.appendChild(wrapper);
			}

			//to add sets per exercise
			function addSetToContainer(container, setNumber) {
				const setRow = document.createElement('div');
				setRow.classList.add('setRow');

				const setLabel = document.createElement('div');
				setLabel.classList.add('setLabel');
				setLabel.textContent = `Set ${setNumber}`;

				const repsLabel = document.createElement('label');
				repsLabel.textContent = 'Reps';
				repsLabel.classList.add('inputLabel');

				const repsInput = document.createElement('input');
				repsInput.type = 'number';
				repsInput.min = 0;
				repsInput.placeholder = '--';
				repsInput.classList.add('smallInput');

				const weightLabel = document.createElement('label');
				weightLabel.textContent = 'Weight';
				weightLabel.classList.add('inputLabel');

				const weightInput = document.createElement('input');
				weightInput.type = 'number';
				weightInput.min = 0;
				weightInput.placeholder = '--';
				weightInput.classList.add('smallInput');

				const unitLabel = document.createElement('label');
				unitLabel.textContent = 'kg';
				unitLabel.classList.add('inputLabel');

				setRow.append(setLabel, repsLabel, repsInput, weightLabel, weightInput, unitLabel);
				container.appendChild(setRow);
			}

			/*** click submit to save data into session storage **/
			const submitBtn = document.querySelector('.submitBtn');
			submitBtn.addEventListener('click', () => {
				const exerciseWrappers = document.querySelectorAll('.exerciseWrapper');
				const exercisesData = [];

				exerciseWrappers.forEach((wrapper) => {
					const box = wrapper.querySelector('.exerciseBox');
					const exerciseName = box.querySelector('.exerciseTitle').textContent;
					const labelsContainer = wrapper.querySelector('.labelsContainer');
					const type = wrapper.querySelector('.setRow') ? 'resistance' : 'cardio';

					if (type === 'resistance') {
						const sets = [];
						wrapper.querySelectorAll('.setRow').forEach((row) => {
							const reps = row.querySelector('input[type="number"]:nth-of-type(1)').value || 0;
							const weight = row.querySelector('input[type="number"]:nth-of-type(2)').value || 0;
							sets.push({reps: parseInt(reps), weight: parseFloat(weight)});
						});
						exercisesData.push({name: exerciseName, type: 'resistance', sets});
					} else {
						// cardio
						const cardioInputs = labelsContainer.querySelectorAll('.cardioInput');
						const distance = cardioInputs[0]?.value || 0;
						const time = cardioInputs[1]?.value || 0;
						const avgPace = cardioInputs[2]?.value || 0;

						exercisesData.push({
							name: exerciseName,
							type: 'cardio',
							distance: parseFloat(distance),
							time: parseFloat(time),
							avgPace: parseFloat(avgPace),
						});
					}
				});

				const workoutData = {
					date: isoDate,
					exercises: exercisesData,
				};

				sessionStorage.setItem('workoutData', JSON.stringify(workoutData));
				saveWorkoutSession(workoutData);
				console.log('Workout saved:', workoutData);
				window.location.href = 'dashboard.html';
			});
		</script>
		<script src="./js/community.js"></script>
		<script src="./js/navbar.js"></script>
	</body>
</html>
